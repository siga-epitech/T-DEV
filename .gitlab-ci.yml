stages:
  - clone
  - install
  - build
  - test
  - deploy

variables:
  NODE_ENV: 'production'
  DOCKER_HOST: "tcp://docker:2375/"
  DOCKER_TLS_CERTDIR: ""

default:
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache git npm
    - npm install -g npm@latest

clone_repos:
  stage: clone
  script:
    - git clone https://$GITLAB_ACCESS_TOKEN@t-dev.epitest.eu/MAR_18/T-DEV-702-Api.git api
    - git clone https://$GITLAB_ACCESS_TOKEN@t-dev.epitest.eu/MAR_18/T-DEV-703-Mobile.git mobile
  artifacts:
    paths:
      - api/
      - mobile/

install_dependencies:
  stage: install
  script:
    - cd trinity && npm install
    - cd ../api && npm install
    - cd ../mobile && npm install
  artifacts:
    paths:
      - trinity/node_modules/
      - api/node_modules/
      - mobile/node_modules/
  only:
    - feature/docker-configuration-siga
    - main
    - dev

build_frontend:
  stage: build
  script:
    - cd trinity
    - npm run build
  artifacts:
    paths:
      - trinity/build
  dependencies:
    - install_dependencies
  only:
    - feature/docker-configuration-siga
    - main
    - dev

build_api:
  stage: build
  script:
    - cd api
    - npm run build
  artifacts:
    paths:
      - api/dist
  dependencies:
    - install_dependencies
  only:
    - feature/docker-configuration-siga
    - main
    - dev

test_frontend:
  stage: test
  script:
    - cd trinity
    - npm test
  only:
    - main
    - dev

test_backend:
  stage: test
  script:
    - cd api
    - npm test
  only:
    - feature/docker-configuration-siga
    - main
    - dev

deploy_dev:
  stage: deploy
  script:
    - docker-compose -f docker-compose.dev.yml up --build -d
  only:
    - feature/docker-configuration-siga
    - dev

deploy_prod:
  stage: deploy
  script:
    - docker-compose -f docker-compose.prod.yml up --build -d
  only:
    - feature/docker-configuration-siga
    - main
  when: manual